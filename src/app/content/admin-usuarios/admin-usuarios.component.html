<div class="container-fluid p-4">

	<header class="bg-light border-bottom">
		<div class="container py-4 px-3">
			<div class="d-flex justify-content-between align-items-center">
				<div class="d-flex align-items-center gap-3">
					<div class="p-2 bg-primary rounded">
						<!-- Icono de archivo (puedes usar Bootstrap Icons o Font Awesome) -->
						<i class="fas fa-users-cog text-white fs-4"></i>
					</div>
					<div class="text-left">
						<h1 class="fw-bold text-dark mb-1 px-0">Administración de usuarios</h1>
						<p class="text-muted mb-0">Administrador de usuarios del sistema</p>
					</div>
				</div>

				<div class="d-flex flex-column align-items-end gap-2 text-muted small">
					
					<span>Última actualización: Hoy</span>
					<span (click)="openLogModal()" role="button" class="historial-link"> <i class="fas fa-clock-rotate-left  me-1"></i>  Ver actividad reciente</span>
				</div>
			</div>
		</div>
	</header>

	<div class="mb-3 d-flex gap-2 justify-content-end w-100 mt-3">
			<div (click)="openCrearUsuarioModal({}, 1)" role="button" class="rounded-3 bg-primary text-white p-2 "> <i
					class="fas fa fa-plus-circle me-2"></i>Crear</div>
	</div>
	<div class="container-fluid mt-4 p-3 bg-gray rounded-3 border-4 ">
		
		<div class="d-flex justify-content-between align-items-center w-100 mb-3">
			<div class="w-90">
			<input type="text" placeholder="Buscar por nombre, correo, rol..." [(ngModel)]="searchTerm"
					(input)="applyFilter()" class="form-control" />
			</div>
			<div class="w-10 text-center">
				<i role="button" class="fas fa-sync-alt text-success" (click)="obtenerUsuarios()"></i>
			</div>

		</div>
		
		<div class="col-md-12 right align-items-right">

			<table class="w-100 table-responsive  table-border-colapse ">
				<thead>
					<tr>
						<td style="width: 20%"> <i class="fas fa-user"></i> Nombre(s) </td>
						<td> <i class="fas fa-at"></i> Correo electrónico </td>
						<td> <i class="fas fa-diagram-project"></i> Rol de usuario </td>
						<td> <i class="fas fa-calendar-alt"></i> Fecha registro </td>
						<td> <i class="fas fa-clock-rotate-left"></i> Último inicio de sesión </td>
						<td style="width: 8%!important"> <span class="tooltip-wrapper" [attr.data-tooltip]="'Estatus'"><i
									class="fas fa-spinner"></i>Estatus</span></td>
						<td> <i class="fas fa-gear"></i> Opciones</td>
					</tr>
				</thead>
				<tbody *ngIf="paginaPersonal.length > 0; else noData">

					<tr *ngFor="let persona of paginaPersonal">
						<!-- <td class="text-center "><span class="tooltip-wrapper" [attr.data-tooltip]="getRandomClass() ? 'Militar': 'Civil'"><i [ngClass]="getRandomClass() ? 'fas fa-person-military-rifle text-success' : 'fas fa-person text-dark-gray'"></i></span></td> -->

						<td >{{ persona.nombre }}</td>
						<td>{{ persona.correo }}</td>
						<td>{{ persona.nombreRol }}</td>
						<td>{{ persona.fechaRegistro  | fechaMexico}}</td>
						<td>{{ persona.fechaInicioSesion ? (persona.fechaInicioSesion | fechaMexico:true ) : 'No ha iniciado Sesion' }}</td>
						<td style="width: 5%;" class="text-center"> <span class="tooltip-wrapper" [attr.data-tooltip]="persona.activo == 1 ? 'activo': 'inactivo'">
								<i class="fas fa-circle " [ngClass]="persona.activo == 1 ? 'text-success': 'text-danger'"></i>
							</span></td>
						<td class="text-center">
							<span class="tooltip-wrapper" [attr.data-tooltip]="'Ver registro'"> <i
									class="tool-icon fas fa-eye" #triggerBtn
									(click)="openCrearUsuarioModal(persona, 2)"></i></span>
							<span class="tooltip-wrapper" [attr.data-tooltip]="'Eliminar registro'"> <i
									class="tool-icon fas fa-cog" #triggerBtn
									(click)="openActivacionModal(persona)"></i></span>
						</td>
					</tr>

				</tbody>

				<ng-template #noData>
					<tbody>
						<tr>
							<td colspan="8" class="text-center py-4 text-muted">
								<i class="fas fa-info-circle me-2"></i>
								No hay registros disponibles.
							</td>
						</tr>
					</tbody>
				</ng-template>
			</table>

			<div class="text-end my-2" *ngIf="personal.length > 0">
				Mostrando del
				<strong>{{ currentPage * pageSize + 1 }} </strong>
				al
				<strong>{{ Math.min((currentPage + 1) * pageSize, filteredPersonal.length) }} </strong>
				de <strong>{{ filteredPersonal.length }}</strong> registros
			</div>
			<div class="pagination">
				<button (click)="prevPage()" [disabled]="currentPage === 0"> <i class="fas fa-caret-left"></i></button>

				<ng-container *ngIf="visiblePages[0] > 0">
					<span>...</span>
				</ng-container>

				<ng-container *ngFor="let page of visiblePages">
					<button (click)="goToPage(page)" [class.active]="page === currentPage">
						{{ page + 1 }}
					</button>
				</ng-container>

				<ng-container *ngIf="visiblePages[visiblePages.length - 1] < totalPages - 1">
					<span>...</span>
				</ng-container>

				<button (click)="nextPage()" [disabled]="currentPage === totalPages - 1"><i class="fas fa-caret-right"></i></button>
			</div>
		</div>

	</div>

</div>

<!-- MODALES -->


<ng-template #crearUsuarioModal let-aceptar="aceptar">
	<div class="container-fluid p-2">
		<form [formGroup]="usuarioForm">

			<div class="row">
				<!-- Nombre -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="nombre">Nombre</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('nombre') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('nombre') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<input id="nombre" type="text" class="form-control" formControlName="nombre"
							[class.invalid]="getValidationStatus('nombre') == 'invalid'"
							[class.valid]="getValidationStatus('nombre') == 'valid'" />
					</div>
					<p *ngIf="getValidationStatus('nombre') == 'invalid'" class="invalid-field">Campo obligatorio.</p>
				</div>

				<!-- Primer Apellido -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="primerApellido">Primer apellido</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('primerApellido') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('primerApellido') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<input id="primerApellido" type="text" class="form-control" formControlName="primerApellido"
							[class.invalid]="getValidationStatus('primerApellido') == 'invalid'"
							[class.valid]="getValidationStatus('primerApellido') == 'valid'" />
					</div>
					<p *ngIf="getValidationStatus('primerApellido') == 'invalid'" class="invalid-field">Campo
						obligatorio.</p>
				</div>

				<!-- Segundo Apellido -->
				<div class="col-md-4">
					<label class="form-label frmlabel" for="segundoApellido">Segundo apellido</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('segundoApellido') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('segundoApellido') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<input id="segundoApellido" type="text" class="form-control" formControlName="segundoApellido"
							[class.invalid]="getValidationStatus('segundoApellido') == 'invalid'"
							[class.valid]="getValidationStatus('segundoApellido') == 'valid'" />
					</div>
					<p *ngIf="getValidationStatus('segundoApellido') == 'invalid'" class="invalid-field">Campo
						obligatorio.</p>
				</div>



			</div>

			<div class="row mt-3">

				<!-- idUsuarioRol -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="idUsuarioRol">Rol de usuario</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('idUsuarioRol') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('idUsuarioRol') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<select id="idUsuarioRol" class="form-control" formControlName="idUsuarioRol"
							[class.invalid]="getValidationStatus('idUsuarioRol') == 'invalid'"
							[class.valid]="getValidationStatus('idUsuarioRol') == 'valid'">
							<option value=null disabled selected>Seleccione</option>
							<option *ngFor="let rol of rolesUsuario" [value]="rol.idUsuarioRol">{{ rol.rol }} -
								{{rol.descripcion}}</option>
						</select>
					</div>
					<p *ngIf="getValidationStatus('idUsuarioRol') == 'invalid'" class="invalid-field">Campo obligatorio.
					</p>
				</div>

				<!-- idDependencia -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="idDependencia">Área de adscripción</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('idDependencia') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('idDependencia') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<select id="idDependencia" class="form-control" formControlName="idDependencia"
							[class.invalid]="getValidationStatus('idDependencia') == 'invalid'"
							[class.valid]="getValidationStatus('idDependencia') == 'valid'">
							<option value=null disabled selected>Seleccione</option>
							<option *ngFor="let depenedencia of dependenciasList"
								[value]="depenedencia.id">{{ depenedencia.area }}</option>
						</select>
					</div>
					<p *ngIf="getValidationStatus('idDependencia') == 'invalid'" class="invalid-field">Campo
						obligatorio.</p>
				</div>

				<!-- Correo -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="correo">Correo</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('correo') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('correo') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<input id="correo" type="email" class="form-control" formControlName="correo"
							[class.invalid]="getValidationStatus('correo') == 'invalid'"
							[class.valid]="getValidationStatus('correo') == 'valid'" />
					</div>
					<p *ngIf="getValidationStatus('correo') == 'invalid'" class="invalid-field">Correo inválido.</p>
				</div>

			</div>

			<div class="row mt-3">

				<!-- UsuarioNombre -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="usuarioNombre">Nombre de usuario</label>
					<div class="input-icon-wrapper">
						<i
							[ngClass]="getValidationStatus('usuarioNombre') == 'valid' ? 'fas fa-check-circle icon valid-icon' : getValidationStatus('usuarioNombre') == 'invalid' ? 'fas fa-times-circle icon invalid-icon': 'd-none'"></i>
						<input id="usuarioNombre" type="text" class="form-control" formControlName="usuarioNombre"
							[class.invalid]="getValidationStatus('usuarioNombre') == 'invalid'"
							[class.valid]="getValidationStatus('usuarioNombre') == 'valid'" />
					</div>
					<p *ngIf="getValidationStatus('usuarioNombre') == 'invalid'" class="invalid-field">Campo
						obligatorio.</p>
				</div>

				<!-- Contraseña -->
				<div class="col-md-4">
					<label class="form-label frmlabel required" for="contrasena">Contraseña</label>
					<div class="input-group">
						<input style="margin-right: 2%;" id="contrasena" [type]="showPassword ? 'text' : 'password'" class="form-control" formControlName="contrasena"
							[class.invalid]="getValidationStatus('contrasena') == 'invalid'"
							[class.valid]="getValidationStatus('contrasena') == 'valid'"
                            (input)="checkPasswordStrength()" />
                       <div style="margin-left: 10px; margin-top: 13px;">
                            <i class="btn btn-outline-secondary" type="button" (click)="togglePasswordVisibility()" class="tool-icon fas fa-eye" [class.fa-eye]="!showPassword" [class.fa-eye-slash]="showPassword"></i>
						</div>
					</div>
                    
                    <div class="form-check mt-2" *ngIf="isEditMode">
                        <input class="form-check-input" type="checkbox" id="changePass" (change)="toggleChangePassword($event)">
                        <label class="form-check-label small text-muted" for="changePass">Cambiar contraseña</label>
                    </div>

					<p *ngIf="getValidationStatus('contrasena') == 'invalid'" class="invalid-field">Campo obligatorio.
					</p>
				</div>

                <!-- progress bar  -->
                <div class="col-md-4 d-flex flex-column justify-content-center">
                    <div class="mt-1" *ngIf="changePasswordEnabled && usuarioForm.get('contrasena')?.value">
                        <label class="form-label small text-muted mb-1">Seguridad de la contraseña</label>
                        <div class="progress" style="height: 8px; margin-right: 100px;">
                            <div class="progress-bar" role="progressbar" 
                                 [ngClass]="passwordStrengthClass" 
                                 [style.width]="passwordStrengthWidth"
                                 aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small [ngClass]="passwordStrengthTextClass" class="fw-bold" style="font-size: 0.75rem;">{{ passwordStrengthLabel }}</small>
                    </div>
                </div>

			</div>

		</form>
		<p class="text-auxiliary text-muted pt-4">* Campos obligatorios</p>
	</div>

	<div class="border-top d-flex justify-content-end p-2 ">
		<button class="btn btn-primary " (click)="aceptar()" [disabled]="usuarioForm.invalid"> Aceptar</button>
	</div>
</ng-template>


<ng-template #eliminarUsuarioModal let-aceptar="aceptar">

		<ng-container *ngIf="usuarioSeleccionado.activo == 0; else elseTemplate">
			<div class="alert alert-warning m-auto" role="alert">
				<strong>Advertencia:</strong> Esta acción <strong>activará</strong> al usuario y recuperará su acceso al sistema, asegúrese de
				que es lo que realmente quiere hacer.
			</div>
			
		</ng-container>
		<ng-template #elseTemplate>
			<div class="alert alert-warning m-auto" role="alert">
				<strong>Advertencia:</strong> Esta acción <strong>desactivará</strong> al usuario y revocará su acceso al sistema, asegúrese de
				que es lo que realmente quiere hacer.
			</div>
			
		</ng-template>
		
</ng-template>
<ng-template #logModal let-aceptar="aceptar">

	<div class="log-container">
  <table class="log-table ">
    <thead>
      <tr>
        <th><i class="fas fa-user-edit"></i> Modificador</th>
        <th><i class="fas fa-user"></i> Afectado</th>
        <th><i class="fas fa-cog"></i> Operación</th>
        <th><i class="fas fa-comment-dots"></i> Observaciones</th>
        <th><i class="fas fa-clock"></i> Fecha</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let log of userlogs">
        <td>{{ log.nombreModificador }}</td>
        <td>{{ log.nombreAfectado }}</td>
        <td><span class="log-op">{{ log.tipoOperacion }}</span></td>
        <td>{{ log.observaciones }}</td>
        <td>{{ log.fechaRegistro | date: 'dd/MM/yyyy HH:mm' }}</td>
      </tr>
    </tbody>
  </table>
</div>



		
</ng-template>